#!/bin/bash
# respberry pi setup script for iot-solar
# first run sudo apt-get -y install git && git clone https://github.com/jstelwag/iot-furnace
# then sh iot-furnace/src/main/bash/setup

sudo apt-get update
sudo apt-get -y upgrade

sudo apt-get -y install cron-apt rpi-update
#sudo rpi-update
sudo apt-get -y install redis-server
sudo apt-get -y install openjdk-8-jdk maven

# allow debugging via pu to I2CMaster
sudo apt-get -y install i2c-tools
sudo adduser pi i2c
echo 'i2c-dev' | sudo tee --append /etc/modules
echo 'dtparam=i2c_arm=on' | sudo tee --append /boot/config.txt
# check with
# i2cdetect -y 1

# you must reboot in order to use i2c

cat <<EOF >iot.conf
influx.ip=192.168.
influx.port=8087
logstash.ip=192.168.
logstash.port=9000
monitor.ip=192.168.
monitor.port=8000
services=FurnaceSlave,FurnaceMonitor,I2CMaster
loggers=FluxLogger
iot.id=kasteel_zolder
boiler.name=boiler120
boiler.sensor=Tbottom
#boiler.name=boiler200
#boiler.sensor=Ttop
EOF
sudo mv iot.conf /etc

cd /tmp
cat <<EOF >iot-upgrade
#!/bin/bash
cd /home/pi/iot-furnace
git pull
sh src/main/bash/iot-upgrade
/usr/bin/crontab /home/pi/iot-furnace/src/main/bash/crontab
EOF
sudo mv iot-upgrade /usr/local/bin
sudo chmod +x /usr/local/bin/iot-upgrade

cat <<EOF >iot-furnace
#!/bin/bash
/bin/sh /home/pi/iot-furnace/src/main/bash/iot-furnace \$@
exit 0
EOF
sudo mv iot-furnace /usr/local/bin
sudo chmod +x /usr/local/bin/iot-furnace

cd ~
iot-upgrade

# test if this works
#sudo usermod -a -G tty pi

sudo nano /etc/iot.conf

cat <<EOF >i2c.service
[Unit]
Description=Java i2c master Service
[Service]
User=pi
# The configuration file application.properties should be here:
#change this to your workspace
WorkingDirectory=/home/pi
#path to executable.
#executable is a bash script which calls jar file
ExecStart=/usr/local/bin/iot-furnace I2CMaster
TimeoutStopSec=10
Restart=on-failure
RestartSec=5
[Install]
WantedBy=multi-user.target
EOF

sudo mv i2c.service /etc/systemd/system/

sudo systemctl daemon-reload
sudo systemctl enable i2c.service
sudo systemctl start i2c
sudo systemctl status i2c

cat <<EOF >http.service
[Unit]
Description=Java http service
[Service]
User=pi
# The configuration file application.properties should be here:
#change this to your workspace
WorkingDirectory=/home/pi
#path to executable.
#executable is a bash script which calls jar file
ExecStart=/usr/local/bin/iot-furnace http
TimeoutStopSec=10
Restart=on-failure
RestartSec=5
[Install]
WantedBy=multi-user.target
EOF

sudo mv http.service /etc/systemd/system/

sudo systemctl daemon-reload
sudo systemctl enable http.service
sudo systemctl start http
sudo systemctl status http

exit 0